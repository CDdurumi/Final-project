<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="Community">
 
 	<!-- 게시글 삽입(생성) -->
	<insert id="insert">
		insert into community 
			values(
					${board_seq}.nextval
					,#{title}
					,#{writer}
					,#{contents}
					,default<!-- write_date -->
					,default<!-- like_count -->
					,default<!-- view_count -->
					,#{hash_tag}
					,default<!-- progress -->
					,default<!--state -->
				 )
		
		<selectKey order="AFTER" keyProperty="board_seq" resultType="string">
			select ${board_seq}.currval from dual
		</selectKey>
	</insert>
	
	<!-- 커뮤니티 메인 인피니스 스크롤 시 카테고리 별 페이지에 해당하는 게시글 -->
	<select id="selectByPage" resultType="kh.spring.DTO.CommunityDTO">
		
		select * from 
						(select row_number() over(order by write_date desc) line, community.* 
						from community

						<trim prefix="where" prefixOverrides="and">
							<if test="category != null and !category.equals('')">
								substr(board_seq,1,1) = #{category}
							</if>
							<if test='searchContent !=null and !searchContent.equals("") and isHash.equals("N")'>
								and title like '%'||#{searchContent}||'%'
								or writer like '%'||#{searchContent}||'%'
								or contents like '%'||#{searchContent}||'%'
							</if>
							<if test='searchContent !=null and !searchContent.equals("") and isHash.equals("Y")'>
								and hash_tag like '%'||#{searchContent}||'%'
							</if>
							
						</trim>

						
						
						)
				where line between #{start} and #{end}
		
	</select>
	
	<!-- 커뮤니티 메인에서 인피니스 스크롤 시 사용되는 카테고리 별 전체 페이지 -->
	<select id="totalPage" resultType="int">
		
		select ceil(count(*)/10) from community 
		
						<trim prefix="where" prefixOverrides="and">
							<if test="category != null and !category.equals('')">
								substr(board_seq,1,1) = #{category}
							</if>
							<if test='searchContent !=null and !searchContent.equals("") and isHash.equals("N")'>
								and title like '%'||#{searchContent}||'%'
								or writer like '%'||#{searchContent}||'%'
								or contents like '%'||#{searchContent}||'%'
							</if>
							<if test='searchContent !=null and !searchContent.equals("") and isHash.equals("Y")'>
								and hash_tag like '%'||#{searchContent}||'%'
							</if>
							
						</trim>
	</select>
	
	
<!-- 	게시글 정보 가져오기 by seq -->
	<select id="selectBySeq" resultType="kh.spring.DTO.CommunityDTO">
		select * from community where board_seq = #{value}
	</select>



	<!-- 게시글 조회 수 up -->
	<update id="viewCountUp">
		update community set view_count = view_count+1 where board_seq = #{value}
	</update>
	


	<!-- 나중에 member-mapper.xml로 옮길 것 -->
	<!-- 해당 id 멤버 정보 get-->
	<select id="selectById" resultType="kh.spring.DTO.MemberDTO">
		select * from member where email = #{value}
	</select>


	<!-- 게시글 수정 -->
	<update id="update">
		update community 
				set title = #{title}
							,contents = #{contents}
							,write_date = default
							,hash_tag = #{hash_tag}
				where board_seq = #{board_seq}
						
	</update>



	<delete id="delete">
		delete from community where board_seq = #{value}
	</delete>



	
	
	<!-- 더미 데이터 만들기 -->
	<insert id="dumy">
		insert into community values('h'||help_seq.nextval
									, '도와주세요'||#{value}
									, 'writer'||#{value}
									, 'contents'||#{value}
									, default
									, default
									, default
									, ''
									, default
									, default
									)
						
	
	</insert>
	
 </mapper>